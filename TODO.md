TODO
 - Make code work with optimisation flags (by inserting `volatile` where appropriate)
